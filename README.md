# README

Проект представляет собой систему Вопросов и Ответов со специализацией на медицинской тематике. В качестве ближайших аналогов можно назвать [stackoverflow.com](http://stackoverflow.com), [quora.com](http://quora.com), [toster.ru](http://toster.ru). Далее в документации такие системы будут обозначаться как QA-системы (Questions and Answers - Вопросы и Ответы). Проект разрабатывался с прицелом на поддержку нескольких сайтов, реализующих нишевые QA-сервисы (школа, здоровье и т.п.). Поэтому проект разбит на два приложения: QA-сервис - сервис, предоставляющий версионированный JSON API для публикации вопросов, ответов, тем и гостевое приложение Рамблер/доктор, который является точкой входа для пользователей, оставляющий вопросы и ответы (с front-части) и редакции (работающей с admin-частью). С API работает только код, для пользователя оно скрыто за оболочкой сайта.

Проект Рамблер/доктор является является частью портала Rambler.ru, поэтому на него накладывается ряд ограничений:
* Дизайн выполняется по гайдам
* Регистрация и вход пользователей осуществляется через Rambler.id, а десктопная и мобильная версии подключают общий для всех разделов Rambler.ru topline - общее меню в верхней части сайта
* Поиск по сайту реализован через Rambler.поиск

## Развертывание проекта

Учитывая описанную выше архитектуру проекта, для успешного развертывания, потребуется поднять два rails-сервера:
* [Рамблер/доктор (текущий проект)](https://gitlab.rambler.ru/rds-doctor/doctor) на порту 3000
* [QA-сервис](https://gitlab.rambler.ru/education/qa-service) на 3001 порту

### Рамблер/доктор

Перед установкой проекта следует убедиться, что на разворачиваемой системе установлены следующие языки программирования и базы данных:
* Ruby 2.3.1
* PostgreSQL
* Redis

Для локального развертывания проекта необходимо склонировать проект из текущего репозитория

    git clone git@gitlab.rambler.ru:rds-doctor/doctor.git

После этого переходим в проект и выполняем установку гемов (выполните `gem install bundler`, если команда не доступна)

    bundle

После этого выполняем создание баз данных, миграции и заполняем таблицу seed-данными

    rake db:reset

В корне проекта следует создать файл .env.local, со следующим содержимым (пароли для основных ролей)

    SUPERUSER_PASSWORD=<password>
    CHIEF_EDITOR_PASSWORD=<password>
    EDITOR_PASSWORD=<password>

После этого можно запустить сервер, который по умолчанию запускается на 3000 порту

    rails s

В том случае, если вы планируете, пользоваться topline-ом, регистироваться, аутентифицироваться, оставлять вопросы, ответы, жаловаться на существующие вопросы и ответы, вам потребуется, во-первых запустить сайт на поддомене develop.rambler.ru (на любом поддомене заканчивающемся на rambler.ru), проще всего прописать алиас для 127.0.0.1 в файле /etc/hosts вашей локальной машины

    127.0.0.1 develop.rambler.ru

После этого, обращение к http://develop.rambler.ru:3000/ будет эквивалентно обращению к http://localhost:3000/.

Во-вторых, вам потребуется авторизоваться на любом портале подключенном к Rambler.id (rambler.ru, lenta.ru) и извлечь значение cookie rsid, которую назначает rambler.id, полученное значение следует передать приложению через переменную окружения RSID, например, так

    RSID=256b5cd9d54384260db3fc9a7523ed75.v1.x rails s

### QA-сервис (JSON API)

Вопросы, ответы, тэги, статусы вопросов обрабатываются отдельным JSON API сервисом. Который должен быть запущен для корректной работы приложения Рамблер/доктор.
Для того на 3001 порту необходимо запустить [QA-сервис](https://gitlab.rambler.ru/education/qa-service).

Для локального развертывания проекта необходимо склонировать проект из приведенного выше репозитория

    git clone git@gitlab.rambler.ru:education/qa-service.git

После этого переходим в проект и выполняем установку гемов (выполните `gem install bundler`, если команда не доступна)

    bundle

После этого выполняем создание баз данных, миграции и заполняем таблицу seed-данными

    bundle exec rake db:reset

После этого можно запустить qa-service, обязательно на 3001 порту:

    bundle exec rails s -p 3001

## Доступ к проекту

В настоящий момент развернуто четыре площадки: стейджинг, стейджинг2, препрод и продакшен, работа которых осуществляется в соответствии с [GitFlow](https://confluence.rambler-co.ru/display/rdswebdev/RDS+Git+workflow). Кратко: staging2 используется для тестирования отдельных веток, staging - для тестирования develop-ветки, preprod - для тестирования релизных веток и хотфиксов, production - для выкатки master-ветки в продакшен. Доступ к закрытой административной части можно уточнить в [Confluence](https://confluence.rambler-co.ru/pages/viewpage.action?pageId=35712691).

Стейджинги имеют облегченную конфигурацию:
* одна фронт-нода Рамблер/доктор (посетители)
* одна бэк-нода Рамблер/доктор (админка)
* одна api-нода JSON API QA-сервиса
* одна общая redis-нода
* две раздельные PostgreSQL базы данных под Рамблер/доктор и QA-сервис

Препрод и продакшен имеют полную конфигурацию, распределенную по двум дата-центрам (связь через postgresql-кластер и через два синтенел-redis-кластера):
* две фронт-ноды Рамблер/доктор
* две бэк-ноды Рамблера/доктор
* две API-ноды JSON API QA-сервиса
* синтенел-кластер Redis для кэша (3 ноды)
* синтенел-кластер Redis для очереди (3 ноды)
* две PostgreSQL базы данных под Рамблер/доктор (запись и чтение - на самом деле кластер)
* две PostgreSQL базы данных под QA-сервис (запись и чтение - на самом деле кластер)

### Локальный проект

Для обращения к front-end части сайта обращаемся по адресу http://localhost:3000/, для обращения к backend-части обращаемся к http://localhost:3000/admin/login. У нас три основные роли:

* Суперпользователь, которому доступны все возможности, логин superuser@class.rambler.ru
* Главный редактор, логин chief_editor@class.rambler.ru
* Редактор с ограниченными возможностями editor@class.rambler.ru.

Для пользователей действует пароль, указанный в .env.local

### Стейджинг2

* http://staging2.admin.doctor.rambler.ru/ - система администрирования
* http://staging2.doctor.rambler.ru/ - фронт-часть сайта

### Стейджинг

* http://staging.admin.doctor.rambler.ru/ - система администрирования
* http://staging.doctor.rambler.ru/ - фронт-часть сайта

### Препрод

* http://preprod.admin.doctor.rambler.ru/ - система администрирования
* http://preprod.doctor.rambler.ru/ - фронт-часть сайта

### Продакшен

* http://admin.doctor.rambler.ru/ - система администрирования
* http://doctor.rambler.ru/ - фронт-часть сайта

## Деплой проекта

Как Рамблер/доктор, так и QA-сервис создавались с использованием Rails 5. Для деплоя QA-сервиса используется команда

    BRANCH=develop bundle exec cap staging deploy

Здесь переменная окружения `BRANCH` указывает какую ветку деплоим на сервер. staging - называние окружения (staging, staging2, preprod, production). По умолчанию используется master ветка, и production окружения, однако, лучше всегда указывать и окружение и ветку.

Проект Рамблер/доктор представляет собой монолит, т.е. админка, фронт-часть и resque-сервер для очередей разрабатываются в рамках одного приложения. Деплой осуществляется сразу на все сервера, например,

    BRANCH=master bundle exec cap staging deploy

Допускается деплой отдельных компонентов приложения, для этого используется стандартная переменная окружения capistrano - `ROLES`

    BRANCH=master ROLES=front bundle exec cap preprod deploy
    BRANCH=master ROLES=backend bundle exec cap preprod deploy
    BRANCH=master ROLES=queue bundle exec cap preprod deploy
